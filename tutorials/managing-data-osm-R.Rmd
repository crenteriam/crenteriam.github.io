---
title: "Accessing and Managing Spatial Data from OpenStreet Maps"
author: "Cesar Renteria"
date: "March 3, 2019"
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 2. Importing the Spatial Data in R

There are two ways to proceed in importing the data in R. The first is directly doing the queries from the OSM’s API. The second is importing the files downloaded through the processes explained in the last section. The first option works only with a small bounding box (0.25 x 0.25 coordinates range), whereas the other option is better for bigger bounding boxes.

The main issue in importing OSM’s Spatial Data is knowing the file format you’re dealing with and its features. The two formats we are interested here are:
.osm: is the native file extension for OpenStreet Maps spatial data. All the API and repositories presented above work with this file (except Overpass Turbo). To import these files in R you need the package [`osmar`](https://cran.r-project.org/web/packages/osmar/osmar.pdf).

**.geoJSON:** another file format for spatial data, used by Overpass Turbo. You can import these files in R with the package “rgdal” (the same we use to import ESRI’s Shapefiles).

For the processes A and B described below, first you need to set a file path where your files are stored. For example:

```{r}
path="C:/Users/Tutorial OSM/"
```
## A. Importing directly from API’s

First, we need the API url. The original API url is `http://api.openstreetmap.org/api/0.6/`, but a better alternative is this mirror: `http://overpass-api.de/api/`. Then, we must create an object that contains the bounding box. In this example, I'm getting the bounding box for the Washington Park in Albany.

First, install the package by using the command `install.packages(“osmar”)`.

Next, with the function `corner_bbox()`, set the bounding box from the coordinates that encompass the Washington Park (check it out in openstreetmap.org with the manual process described here).

```{r}
box.wpark=corner_bbox(-73.7774,42.6530,-73.7652,42.6623)
```

Then, we must create an object with the API's url. In order to do that, we need to use the function osmsource_api(). You could use either api.openstreetmap.org or overpass-api.de.

```{r}
api.wpark=osmsource_api(url = "http://api.openstreetmap.org/api/0.6/")
```
The third object gets the OSM file from the bounding box and the url above. First, set the bounding box, and then the source.
wpark=get_osm(box.wpark, api.wpark)

The data is now manageable in R, but it is an OSM object, and this is not useful for our purposes (type plot(wpark) and class(wpark) to see the results). As stated before, a nice feature of OSM and GeoJSON files is that they can include multiple layers (points, lines and polygons) in the same file, but this is not quite the structure that R is expecting from a Spatial object. We need to transform the .osm file to a Spatial object in R where only one layer is allowed per object (either point, line or polygon); if we want to work with the three of them (as in this example), then we need to create three different Spatial objects out of our OSM object. To do these conversions we must use the function as_sp().
area.wpark=as_sp(wpark,what="polygons") #To get polygons
street.wpark=as_sp(wpark,what="lines") #To get lines
attr.wpark=as_sp(wpark,what="points") #To get points
Now, we have three Spatial objects. See maps plotted.
plot(area.wpark,col="gray")
plot(street.wpark, add=TRUE,col="blue")
plot(attr.wpark, add=TRUE,col="red",pch=1)

B. Importing from OSM files
First, create an object with the .osm source file. In this case, I set a working directory prior. If you didn’t, put the complete file path. For this step use the function osmsource_file(). Next coding line doesn’t load the data, just sets the path.
source.albany=osmsource_file("albany.osm")
Then, to load the data, we use the same function as with APIs, but since the file must already contain the bounding box, in the coding line, instead of placing our bounding box object, we just put this: complete_file().
albany=get_osm(complete_file(),source=source.albany)
Now, we must transform the OSM object into one or many Spatial objects.
area.albany=as_sp(albany,what="polygons")
street.albany=as_sp(albany,what="lines")
Plot the results.
plot(area.albany)
plot(street.albany,add=TRUE,col="green")

C. Importing from GeoJSON files7
To import these files, you need to load the rgdal package. I’ve got the GeoJSON files from Overpass Turbo (OT); in this case, I’ve got highways from OT. To work through this, first, inspect the structure of the GeoJSON file. In the first line (ogrListLayers()), put the name of the file (provided a workspace path). Inspect the basic features of the file. It will tell you how many layers are in the GeoJSON file. In the second line (ogrInfo()), you need to specify the file, the extension (“OGRGeoJSON”), and the type of layer (line). This will tell you the attributes in the layer.
ogrListLayers("highways.geojson") #Structure of my dataset from Overpass Turbo (OT)
ogrInfo("highways.geojson", "OGRGeoJSON", require_geomType="wkbLineString") #Getting more information from my OT data set
# ALTERNATIVES: require_geomType="wkbPoint" OR require_geomType="wkbPolygon"
Then, convert this to a Spatial object. The structure is the same as explained above. We’re only extracting the lines layer (indeed, this is the only layer in this GeoJSON file).
highways = readOGR("highways.geojson", "OGRGeoJSON", require_geomType="wkbLineString")
class(highways) # Check the class of the new object
plot(highways)
D. Export to Shapefile.
With the information provided above you would be allowed to do your spatial analysis. However, if you need to export the objects as ESRI’s Shapefiles, use one of the two following lines: 8
# write a new shapefile with package rgdal (including .prj component)
writeOGR(highways, ".", "highways_prj", driver="ESRI Shapefile")
# Alternatively, write a new shapefile with package maptools (without .prj)
# writePolyShape(highways, "highways_noprj")


[^X] 7 Further details http://rstudio-pubs-static.s3.amazonaws.com/84577_d3eb8b4712b64dbdb810773578d3c726.html
[^X] 8 See further details in RPOS 619 tutorial https://www.youtube.com/watch?v=oPsKeC_EMX0
Or “Read and write ESRI Shapefiles with R“: https://www.nceas.ucsb.edu/scicomp/usecases/ReadWriteESRIShapeFiles
